<!DOCTYPE html>
<html lang="en">
<head>
    <title>一起来画像素画</title>
    <link rel="stylesheet" href="./static/pixel/css/styles.css?v=0.0.31" type="text/css"/>
    <meta charset="UTF-8">
    <meta name="description" content="像素画小游戏, tebie6, 一起来画像素画, rplace, Rplace, r/place, R/place">
    <meta name="keywords" content="像素画小游戏, tebie6, 一起来画像素画, rplace, Rplace, r/place, R/place">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
</head>

<body style="overflow: hidden; position: fixed;">
<div id="page">
    <div id="danmu-container">
        <!-- 弹幕将在这里显示 -->
    </div>
    <div id="posel" class="layout" noselect="">(0,0)</div>
    <div class="chat-container">
        <div class="chat-header">
            Live Chat:
            <div class="users-count">当前在线人数：<span class="online">0</span></div>
            <button class="close-chat">X</button>
        </div>
        <div class="chat-messages">
            <!-- Additional messages -->
        </div>
        <div class="chat-input-container">
            <input type="text" class="chat-input" placeholder="输入内容...">
            <button class="action-button send-button">发送弹幕</button>
        </div>
    </div>

    <div id="pageContent">
        <div id="imgContainer">
            <canvas id="myCanvas" width="1000" height="1000"
                    style="border:1px solid #c3c3c3;image-rendering: pixelated;display: inline-block;"></canvas>
        </div>
    </div>
</div>
<div id="helpbtn" class="layout" noselect="" >
    <img src="./static/pixel/img/help.svg">
</div>
<div id="morebtn" class="layout" noselect="" >
    ...
</div>
<div id="chatbtn" class="layout" noselect="">
    <img src="./static/pixel/img/chat.svg" style="width:20px; height:27px">
</div>
<div class="extraInfo">
    <div style="padding-bottom: 10px;border-bottom: 1px solid;margin-bottom: 5px;">
        <div style="display: block;text-align: center;">当前在线人数：<span class="online">0</span></div>
    </div>
    <div>
        <div id="nickname" ></div>
    </div>
    <div id="onlineList"></div>
    <div id="updateRecord"></div>
    <div id="changeBackgroundMode"></div>
    <div>
        <div id="closeOnlineList">收 起</div>
    </div>
</div>
<div class="bigContent" style="display: none;">
    <div class="bigContentBody">

    </div>
    <div id="closebt1" class="closebt" align="center"> 关 闭 </div>
</div>
<span class="tooltiptext" style="display: none;">双击删除颜色</span>
<div class="recentUseColor" style="overflow: auto;white-space: nowrap;"></div>
<footer id="footer" style="overflow: auto;white-space: nowrap;"></footer>
<div id="moreOptionsPanel">
    <!-- 在这里添加更多选项的内容 -->
    <a href="javascript:void(0)">祝各位老板2024年发大财️💰，500W打底</a>
    <a href="/2023.html" target="_blank">👉2023年度像素画游戏报告👈</a>
    <a href="https://github.com/tebie6/pixel_game" target="_blank">GitHub项目地址</a>
</div>
<div class="notice" style="display: none">提示</div>
<div class="modal"></div>
</body>
<script src="./static/pixel/js/jquery-1.11.0.min.js"></script>
<script src="./static/pixel/js/e-smart-zoom-jquery.js?v=0.0.10"></script>
<script src="./static/pixel/js/pako.min.js"></script>
<script src="./static/pixel/js/ConnWs.js?v=0.0.16"></script>
<script>
    $(document).ready(function () {
        var serverHost = window.location.hostname;
        var apiUrl = serverHost + "/api"
        var wsUrl = serverHost
        var nickname = "";
        var id = "";
        var danmuColorsIndex = Math.floor(Math.random() * 10);
        var loadMode = localStorage.getItem("load_mode");   // 0:ws推送内容、1:图片加载
        loadMode = loadMode == null ? 1 : parseInt(loadMode);

        let errorMap = new Map();
        let debounceTime = 1000; // 防抖时间，例如 1 秒
        // 报错监控
        window.onerror = function (message, source, lineno, colno, error) {
            const errorKey = message;
            const currentTime = Date.now();

            if (!errorMap.has(errorKey) || currentTime - errorMap.get(errorKey) > debounceTime) {
                errorMap.set(errorKey, currentTime);

                sendErrorToServer({
                    message: message,
                    source: source,
                    lineno: lineno,
                    colno: colno,
                    stack: error ? error.stack : null,
                    access_token: getAccessToken(),
                });
            }
        };

        function sendErrorToServer(errorData) {
            $.ajax({
                url: `//${apiUrl}/pixel/errorReporting`,
                type: 'POST',
                // 用于设置响应体的类型 注意 跟 data 参数没关系！！！
                dataType: 'json',
                data: errorData,
                async: true,
                beforeSend: function (xhr) {
                    // 在所有发送请求的操作（open, send）之前执行
                    console.log('beforeSend', xhr)
                },
                success: function (res) {
                    console.log('上报成功')

                    // 清除过期的错误日志
                    const currentTime = Date.now();
                    errorMap.forEach((value, key) => {
                        if (currentTime - value > debounceTime) {
                            errorMap.delete(key);
                        }
                    });
                },
                error: function (xhr) {
                    // 隐藏 loading
                    // 只有请求不正常（状态码不为200）才会执行
                    console.log('error', xhr)
                },
                complete: function (xhr) {
                    // 不管是成功还是失败都是完成，都会执行这个 complete 函数
                    console.log('complete', xhr)
                }
            })
        }

        var wsObj = null;
        var listLoadingContent = `<h2>画布加载中。。。</h2>
 <div class="progress-container">
        <div class="progress-bar" id="myBar">1%</div>
    </div>
        <h4>大约需要5-10秒</h4>
        <h4>右下角可以发送 <span class="goldText">弹幕🌈</span> 哦！</h4>
<h4>右上角<span class="goldText">帮助</span>有教程！！！</h4>`

        var colorList = '{"1":"0,0,0","2":"85,85,85","3":"136,136,136","4":"205,205,205","0":"255,255,255","5":"255,213,188","6":"255,183,131","7":"182,109,61","8":"119,67,31","9":"252,117,16","10":"252,168,14","11":"253,232,23","12":"255,244,145","13":"190,255,64","14":"112,221,19","15":"49,161,23","16":"50,182,159","17":"136,255,243","18":"36,181,254","19":"18,92,199","20":"38,41,96","21":"139,47,168","22":"255,89,239","23":"255,169,217","24":"255,100,116","25":"240,37,35","26":"177,18,6","27":"116,12,0","100":"0,0,0","101":"105,105,105","102":"128,128,128","103":"169,169,169","104":"192,192,192","105":"211,211,211","106":"220,220,220","107":"245,245,245","108":"255,255,255","109":"128,0,0","110":"139,0,0","111":"178,34,34","112":"165,42,42","113":"255,0,0","114":"205,92,92","115":"188,143,143","116":"240,128,128","117":"255,250,250","118":"250,128,114","119":"255,228,225","120":"255,99,71","121":"233,150,122","122":"255,69,0","123":"255,127,80","124":"255,160,122","125":"160,82,45","126":"255,245,238","127":"139,69,19","128":"210,105,30","129":"244,164,96","130":"255,218,185","131":"205,133,63","132":"250,240,230","133":"255,140,0","134":"255,228,196","135":"222,184,135","136":"210,180,140","137":"250,235,215","138":"255,222,173","139":"255,235,205","140":"255,239,213","141":"255,165,0","142":"255,228,181","143":"245,222,179","144":"253,245,230","145":"255,250,240","146":"218,165,32","147":"255,248,220","148":"255,215,0","149":"240,230,140","150":"238,232,170","151":"255,250,205","152":"189,183,107","153":"128,128,0","154":"255,255,0","155":"255,255,224","156":"255,255,240","157":"250,250,210","158":"245,245,220","159":"85,107,47","160":"173,255,47","161":"124,252,0","162":"127,255,0","163":"0,100,0","164":"0,128,0","165":"34,139,34","166":"0,255,0","167":"50,205,50","168":"143,188,143","169":"152,251,152","170":"144,238,144","171":"240,255,240","172":"46,139,87","173":"60,179,113","174":"245,255,250","175":"0,255,127","176":"0,250,154","177":"127,255,170","178":"64,224,208","179":"32,178,170","180":"72,209,204","181":"0,128,128","182":"0,139,139","183":"47,79,79","184":"0,206,209","185":"212,242,231","186":"0,255,255","187":"175,238,238","188":"225,255,255","189":"240,255,255","190":"95,158,160","191":"176,224,230","192":"173,216,230","193":"0,191,255","194":"135,206,235","195":"135,206,250","196":"70,130,180","197":"240,248,255","198":"30,144,255","199":"112,128,144","200":"119,136,153","201":"176,196,222","202":"100,149,237","203":"65,105,225","204":"0,0,128","205":"0,0,139","206":"25,25,112","207":"0,0,205","208":"0,0,255","209":"248,248,255","210":"230,230,250","211":"72,61,139","212":"106,90,205","213":"123,104,238","214":"147,112,219","215":"138,43,226","216":"75,0,130","217":"153,50,204","218":"148,0,211","219":"186,85,211","220":"128,0,128","221":"139,0,139","222":"255,0,255","223":"255,0,255","224":"238,130,238","225":"221,160,221","226":"216,191,216","227":"218,112,214","228":"199,21,133","229":"255,20,147","230":"255,105,180","231":"219,112,147","232":"255,240,245","233":"220,20,60","234":"255,192,203","235":"255,182,193"}';
        colorList = JSON.parse(colorList)

        // 颜色选择器
        colorSelector();
        function colorSelector() {
            var html = `<div class="colorSelector">切换完整颜色</div>`
            var recentUseColorHtml = `<div class="recentUseColorText">最近使用</div>`
            for (const color in colorList) {
                var rgb = colorList[color]

                // 默认选中
                var picked = '';
                if (color == 1 || color == 100) {
                    picked = 'picked'
                }

                // 分组
                var group = 'selector1'
                if (color >= 100) {
                    group = 'selector2'
                }

                // 色系判断颜色标号
                var textColorBlack = ''
                var colorChange = rgb.split(",")
                var grayLevel = colorChange[0] * 0.299 + colorChange[1] * 0.587 + colorChange[2] * 0.114;
                if (grayLevel >= 192) {//浅色模式
                    textColorBlack = 'textColorBlack'
                } else {
                    textColorBlack = ''
                }

                html += `<div data-color="color${color}" class="palette ${picked} ${group} ${textColorBlack}" style="background-color: rgb(${rgb});">${color}</div>`
                recentUseColorHtml += `<div data-color="color${color}" class="palette selector3 ${textColorBlack}"
                                           style="background-color: rgb(${rgb});">${color}</div>`
            }
            $(".recentUseColor").hide().html(recentUseColorHtml);
            $("footer").html(html)
            $(".selector2,.selector3").hide();
        }

        // 切换颜色分组
        $('body').on('click', '.colorSelector', function (){
            if ($(this).text() == '切换完整颜色') {
                $(this).text("切换基础颜色")
                $(".selector1").hide();
                $(".selector2").show();
            } else {
                $(this).text("切换完整颜色")
                $(".selector1").show();
                $(".selector2").hide();
            }
        })

        var sUserAgent = navigator.userAgent.toLowerCase();
        var bIsIpad = sUserAgent.match(/ipad/i) == "ipad";
        var bIsIphoneOs = sUserAgent.match(/iphone os/i) == "iphone os";
        var bIsMidp = sUserAgent.match(/midp/i) == "midp";
        var bIsUc7 = sUserAgent.match(/rv:1.2.3.4/i) == "rv:1.2.3.4";
        var bIsUc = sUserAgent.match(/ucweb/i) == "ucweb";
        var bIsAndroid = sUserAgent.match(/android/i) == "android";
        var bIsCE = sUserAgent.match(/windows ce/i) == "windows ce";
        var bIsWM = sUserAgent.match(/windows mobile/i) == "windows mobile";
        function isPhone() {
            if (bIsIpad || bIsIphoneOs || bIsMidp || bIsUc7 || bIsUc || bIsAndroid || bIsCE || bIsWM) {
                return true;
            }
            return false;
        }

        if (isPhone()) {
            $("#pageContent").css("margin-top", "50%")
        }

        // containerClass: 如果你想改变背景或边框，可以将该类应用于缩放目标容器（不要通过css改变大小或位置）。
        $('#myCanvas').smartZoom({
            'containerClass': 'zoomableContainer',
        });

        if (isPhone()) {
            $('#myCanvas').smartZoom('zoom', 2.5);
            setTimeout(function (){
                $('#myCanvas').smartZoom('pan', 0, 600, 1);
            }, 100)
        } else {
            $('#myCanvas').smartZoom('zoom', 0.8);
            setTimeout(function (){
                $('#myCanvas').smartZoom('pan', 0, 300, 1);
            }, 100)
        }

        var canvas = document.getElementById("myCanvas");
        var context = canvas.getContext("2d");

        // 用于缩放拖拽使用
        var img = new Image();

        var mouseX = 0;
        var mouseY = 0;
        var pixelList = [];
        var borderHistory = [];
        var draw = false
        var copyColorTask = null;

        canvas.onmousemove = function (e) {
            moveHandle(e)
            // 清除复制颜色
            cancelCopyColor()
        };

        if (checkLogin()) {
            doConnect(getAccessToken())
        } else {
            visitorLogin();
        }

        // 设置像素
        canvas.onmousedown = function () {
            console.log('onmousedown')
            // 复制颜色
            copyColor()

            draw = true
        }
        canvas.onclick = function (e) {
            // 取消复制颜色
            cancelCopyColor()

            console.log('onclick')
            if (draw) {
                savePixel()
            }
            draw = false
        }

        // 设置像素
        canvas.ontouchstart = function (e) {
            console.log('ontouchstart')
            var touchList = e.touches
            if (touchList.length > 1) {
                // 清除复制颜色
                cancelCopyColor()
            }
            moveHandle(touchList[0])
            draw = true

            // 复制颜色
            copyColor()
        }
        canvas.ontouchmove = function (e) {
            // console.log(e)
            // 清除复制颜色
            cancelCopyColor()

            console.log('ontouchmove')
            draw = false
        }
        canvas.ontouchend = function (e) {
            // 取消复制颜色
            cancelCopyColor()

            console.log('ontouchend')
            if (draw) {
                savePixel()
            }
            draw = false
        }

        // 消息提示
        function notice(content, speed = 400) {
            $(".notice").html(content).fadeIn(200)
            setTimeout(function (){
                $(".notice").fadeOut(speed)
            }, 1500)
        }

        // 切换背景模式
        var backgroundMode = localStorage.getItem("backgroundMode") ? localStorage.getItem("backgroundMode") : 'Light' // Dark
        if (backgroundMode == 'Light') {
            backgroundMode = 'Dark'
        } else {
            backgroundMode = 'Light'
        }
        changeBackgroundMode(false);
        $("#changeBackgroundMode").click(function () {
            changeBackgroundMode(true);
        })
        function changeBackgroundMode(loadList) {
            console.log('backgroundMode', backgroundMode)
            if (backgroundMode == 'Light') {
                backgroundMode = 'Dark'
                context.fillStyle = '#343541'
                context.fillRect(0, 0, canvas.width, canvas.height)
                $("#myCanvas").css("border", "1px solid rgb(0,0,0)")
                $("#changeBackgroundMode").text("切换日常模式")
            } else {
                backgroundMode = 'Light'
                context.fillStyle = '#ffffff'
                context.fillRect(0, 0, canvas.width, canvas.height)
                $("#myCanvas").css("border", "1px solid rgb(195, 195, 195)")
                $("#changeBackgroundMode").text("切换黑夜模式")
            }
            localStorage.setItem("backgroundMode", backgroundMode)
            if (loadList) {
                getPixelList();
            }
        }

        // 复制颜色
        function copyColor() {

            if (copyColorTask != null) {
                return
            }

            copyColorTask = setTimeout(function (){
                var color = 0
                if (pixelList[mouseX] != undefined && pixelList[mouseX][mouseY] != undefined) {
                    color = pixelList[mouseX][mouseY]
                } else {
                    // 获取像素数据
                    const pixel = context.getImageData(mouseX, mouseY, 1, 1);
                    const data = pixel.data;

                    // 查询效率O(N)
                    const valueToFind = data[0]+","+data[1]+","+data[2]
                    const key = Object.keys(colorList).find(key => colorList[key] === valueToFind);
                    if (key !== undefined) {
                        color = key
                    }
                }
                $('.palette').removeClass('picked');
                $('footer > [data-color="color'+color+'"]').addClass('picked');
                var rgb = colorList[color]
                notice(`取色成功！<div style="background-color: rgb(${rgb});width: 12px; height: 12px;display: inline-block;"></div>`)
                console.log('copy color', color)
                draw = false
            }, 500)
        }

        // 取消复制颜色
        function cancelCopyColor() {
            if (copyColorTask == null) {
                return
            }

            clearTimeout(copyColorTask)
            copyColorTask = null
        }

        var notified = false;
        var lastSavePixel = ""
        function savePixel() {
            // 验证登录状态
            if (!checkLogin()) {
                console.log("未登录")
                return
            }

            // 渲染页面
            var color = $(".picked").attr("data-color").slice(5);

            // 防抖
            if (lastSavePixel == mouseX+":"+mouseY+":"+color) {
                return
            }
            lastSavePixel = mouseX+":"+mouseY+":"+color

            drawPoint(mouseX, mouseY, color);

            $(".recentUseColor").show();
            $("footer").css({'box-shadow':"none"});
            $('[data-color="color'+color+'"]').show();

            if (!notified) {
                $(".tooltiptext").show();
                setInterval(function (){
                    $(".tooltiptext").fadeOut(400)
                }, 2000)
                notified = true;
            }
            // 同步数据
            wsObj.sendMSG("pixel_add", {
                x: mouseX,
                y: mouseY,
                color: parseInt(color)
            })
        }

        // 展示像素更新记录
        var lastDisplayUpdateRecordTime = 0
        function displayUpdateRecord(x, y, color) {
            const currentTime = Date.now();
            if (currentTime - lastDisplayUpdateRecordTime < 1000) {
                return
            }
            lastDisplayUpdateRecordTime = currentTime;
            var rgb = colorList[color]
            $("#updateRecord").html(`(${x},${y})<div style="background-color: rgb(${rgb});width: 12px; height: 12px;display: inline-block;margin-left: 5px;"></div>`)
        }

        function moveHandle(e) {
            // console.log(e)
            draw = false
            var location = getLocation(e.clientX, e.clientY);
            location.x = Math.floor(location.x);
            location.y = Math.floor(location.y);

            // 记录鼠标所在的x、y
            mouseX = location.x < 0 ? 0 : location.x;
            mouseY = location.y < 0 ? 0 : location.y;

            $("#posel").text(`(${mouseX},${mouseY})`)
            // console.log("x"+mouseX+" y:"+mouseY)
        }

        function doConnect(token) {
            let wsHost = `ws://${wsUrl}`
            wsObj = new ConnWs(wsHost, dealAction, updateUUID, openCallback, closeCallback, token, loadMode)
        }

        /**
         * 路由收到的服务器响应数据
         * @param msgid 双字节无符号整数，消息id，0-65535
         * @param content 消息正文
         */
        function dealAction(msgid, content) {
            // console.log("deal action data ", msgid, content);

            switch (msgid) {

                case 'broadcast':
                    var action = content.data.action
                    if (action === 'pixel_add') {
                        var x = content.data.x
                        var y = content.data.y
                        var color = content.data.color
                        drawPoint(x, y, color);
                        displayUpdateRecord(x, y, color)
                    } else if (action === 'online') {
                        $(".online").text(content.data.online)
                        getOnlineList(content.data)
                    } else if (action === 'chat_push') {
                        appendChatMsg(content.data.nickname, content.data.msg)
                        // 消息抖动提醒
                        chatShake()
                        // 弹幕效果
                        addDanmu(content.data.msg)
                    }

                    break;

                case 'auth_resp':
                    if (content.msg == 'auth error') {
                    } else if(content.msg == 'blocked') {
                    } else {
                        id = content.id
                        nickname = content.nickname
                        $("#nickname").html(`<div class="rank" id="${content.id}" style="color: #FFD700FF">${content.nickname}</div>`)

                        $(".bigContentBody").html(listLoadingContent)
                        $(".bigContent").show();
                        getOnlineList()
                        if (loadMode === 1) {
                            loadCanvas();
                        }
                    }
                    break;
                case 'pixel_resp':
                    var action = content.data.action
                    if (action === undefined) {
                        var list = content.data.d
                        for (const key in list) {
                            var xy = key.split(":")
                            var x = xy[0];
                            var y = xy[1]
                            drawPoint(x, y, list[key]);
                        }
                        // 更近进度条
                        $('.bigContentBody').find('#myBar').text(content.data.p+"%").css({
                            width: content.data.p+"%"
                        });
                    } else if(action === 'pixel_add_finish') {
                        $(".bigContent").hide();
                        notice(`画布加载完成！`)
                        $("#updateRecord").html("");
                    }

                    break;
                default:
                    console.log("unsupported action:", msgid);
                    break;
            }
        }

        function updateUUID() {
            getAccessToken();
        }

        function openCallback() {
            $("#updateRecord").html("");
        }

        function closeCallback() {
            $("#updateRecord").html(`<span style="color: #FF3030">连接已断开</span>`);
        }

        function getPixelList() {

            if (loadMode === 1) {
                loadCanvas();
                return
            }

            $(".bigContentBody").html(listLoadingContent)
            $(".bigContent").show();

            let progressPercentage = 0;
            const progressUpdateTimer = setInterval(() => {
                if (progressPercentage >= 99) {
                    clearInterval(progressUpdateTimer);
                } else {
                    const progressStep = (Math.random() + 1) * 20;
                    progressPercentage += progressStep;
                    progressPercentage = parseFloat(progressPercentage.toFixed(2)); // 格式化为两位小数并转换为数字
                    progressPercentage = Math.min(99.99, progressPercentage); // 确保不超过 99.99%
                    // 更近进度条
                    $('.bigContentBody').find('#myBar').text(progressPercentage+"%").css({
                        width: progressPercentage+"%"
                    });
                }
            }, 1000);

            $.ajax({
                url: `//${apiUrl}/pixel/list`,
                type: 'POST',
                // 用于设置响应体的类型 注意 跟 data 参数没关系！！！
                dataType: 'json',
                async: true,
                beforeSend: function (xhr) {
                    // 在所有发送请求的操作（open, send）之前执行
                    console.log('beforeSend', xhr)
                },
                success: function (res) {
                    // 隐藏 loading
                    // 只有请求成功（状态码为200）才会执行这个函数
                    if (res.code != 0) {
                        alert(res.msg)
                        return;
                    }

                    var list = res.data.list
                    for (const key in list) {
                        var xy = key.split(":")
                        var x = xy[0];
                        var y = xy[1]
                        drawPoint(x, y, list[key]);
                    }

                    clearInterval(progressUpdateTimer);
                    // 更近进度条
                    $('.bigContentBody').find('#myBar').text("100%").css({
                        width: "100%"
                    });

                    // 防止闪屏
                    setTimeout(function (){
                        $(".bigContent").hide();
                    }, 500)
                },
                error: function (xhr) {
                    // 隐藏 loading
                    // 只有请求不正常（状态码不为200）才会执行
                    console.log('error', xhr)
                },
                complete: function (xhr) {
                    // 不管是成功还是失败都是完成，都会执行这个 complete 函数
                    console.log('complete', xhr)
                }
            })
        }

        function getOnlineList(data) {

            if (data !== undefined) {

                if (data.id == id) {
                    return
                }

                $("#"+data.id).remove();
                if (data.type == 'join') {
                    $("#onlineList").append(`<div class="onlineRow" id="${data.id}">
            <div class="rank"><span>${data.nickname}</span></div>`)
                }

                return
            }

            $.ajax({
                url: `//${apiUrl}/pixel/online/list`,
                type: 'POST',
                // 用于设置响应体的类型 注意 跟 data 参数没关系！！！
                dataType: 'json',
                async: true,
                beforeSend: function (xhr) {
                    // 在所有发送请求的操作（open, send）之前执行
                    console.log('beforeSend', xhr)
                },
                success: function (res) {
                    // 隐藏 loading
                    // 只有请求成功（状态码为200）才会执行这个函数
                    if (res.code != 0) {
                        alert(res.msg)
                        return;
                    }

                    let html = ""
                    var list = res.data.list
                    for (let i = 0; i < list.length; i++) {
                        if (id === list[i].id) continue;

                        html += `<div class="onlineRow" id="${list[i].id}">
            <div class="rank"><span>${list[i].nickname}</span></div>
        </div>`
                    }

                    $("#onlineList").html(html)

                },
                error: function (xhr) {
                    // 隐藏 loading
                    // 只有请求不正常（状态码不为200）才会执行
                    console.log('error', xhr)
                },
                complete: function (xhr) {
                    // 不管是成功还是失败都是完成，都会执行这个 complete 函数
                    console.log('complete', xhr)
                }
            })
        }

        // 获取视口定位
        function getLocation(x, y) {
            var bbox = canvas.getBoundingClientRect();
            return {
                x: (x - bbox.left) * (canvas.width / bbox.width),
                y: (y - bbox.top) * (canvas.height / bbox.height)
            };
        }

        // 渲染像素点
        function drawPoint(x, y, c) {

            if (pixelList[x] === undefined) {
                pixelList[x] = [];
            }
            pixelList[x][y] = c;

            if (colorList[c] === undefined) {
                context.fillStyle = "#FFFFFF";
            } else {
                context.fillStyle = "rgb("+ colorList[c] +")";
            }
            context.fillRect(x, y, 1, 1);
        }

        // 切换颜色
        $('.palette').click(function () {
            $('.palette').removeClass('picked');
            $(this).addClass('picked');
        });

        // 双击删除最近使用颜色
        $(".selector3").dblclick(function (){
            if (confirm("移除该颜色？")) {
                $(this).hide();
            }
        })

        function getAccessToken() {
            return localStorage.getItem("access_token");
        }

        // 检测登录
        function checkLogin() {
            return localStorage.getItem("access_token") !== null;
        }

        // 游客登录
        function visitorLogin() {
            // 获取临时访问token
            $.ajax({
                url: `//${apiUrl}/visitor/login`,
                type: 'POST',
                // 用于设置响应体的类型 注意 跟 data 参数没关系！！！
                dataType: 'json',
                beforeSend: function (xhr) {
                    // 在所有发送请求的操作（open, send）之前执行
                    console.log('beforeSend', xhr)
                },
                success: function (res) {
                    // 隐藏 loading
                    // 只有请求成功（状态码为200）才会执行这个函数
                    console.log(res)

                    if (res.code != 0) {
                        alert(res.msg)
                        return;
                    }

                    // 保存登录状态
                    localStorage.setItem("access_token", res.data.access_token)
                    doConnect(res.data.access_token)
                },
                error: function (xhr) {
                    // 隐藏 loading
                    // 只有请求不正常（状态码不为200）才会执行
                    console.log('error', xhr)
                },
                complete: function (xhr) {
                    // 不管是成功还是失败都是完成，都会执行这个 complete 函数
                    console.log('complete', xhr)
                }
            })
        }

        $("#closeOnlineList").click(function (){
            $("#onlineList").toggle();
            if ($(this).text() == '收 起') {
                startMediaRecorder()
                $(this).text("展 开")
            } else {
                stopMediaRecorder()
                $(this).text("收 起")
            }

        })

        $("#helpbtn").click(function (){
            if (isPhone()) {
                $(".bigContentBody").html(`<h2>帮助：</h2>
        <ul>
            <li>双指捏合🤏<span class="goldText">放大缩小</span>🔍</li>
            <li>单指点击<span class="goldText">上色</span></li>
            <li>单指<span class="goldText">拖拽画布</span></li>
            <li>长按画布中的颜色可<span class="goldText">取色</span></li>
            <li>底下选颜色</li>
            <li>双击最近使用颜色可<span class="goldText">移除颜色</span></li>
            <li>小红书📕搜索🔍<span class="goldText">像素画</span>选择自己喜欢的内容</li>
            <li>问题反馈：<span class="goldText">liumingyuphp@163.com</span></li>
        </ul>`)
            } else {
                $(".bigContentBody").html(`<h2>帮助：</h2>
        <ul>
            <li>鼠标滚轴<span class="goldText">缩放</span></li>
            <li>左键点击<span class="goldText">上色</span></li>
            <li>按住拖动画布</li>
            <li>长按画布中的颜色可<span class="goldText">取色</span></li>
            <li>底下选颜色</li>
            <li>双击最近使用颜色可<span class="goldText">移除颜色</span></li>
            <li>右键下载当前画布</li>
            <li>小红书📕搜索🔍<span class="goldText">像素画</span>选择自己喜欢的内容</li>
            <li>问题反馈：<span class="goldText">liumingyuphp@163.com</span></li>
        </ul>`)
            }
            $(".bigContent").show();
        })

        $("#closebt1").click(function (){
            $(".bigContent").hide();
        })

        // 加载时抖动增加关注
        // 消息提示
        chatShake(5000);
        function chatShake(s) {

            if ($('.chat-container').is(':visible')) {
                return;
            }

            $("#chatbtn").addClass("shake")
            setTimeout(function (){
                $("#chatbtn").removeClass("shake")
            }, s === undefined ? 1500 : s)
        }

        // 关闭聊天框
        $('.close-chat').click(function() {
            // $('.chat-container').hide(300);
            if (isPhone()) {
                $('.chat-container').css("right", '-146%')
            } else {
                $('.chat-container').css("right", '0px')
            }
        });

        // 打开聊天框
        $("#chatbtn").click(function () {
            // $('.chat-container').show(300);
            if (isPhone()) {
                $('.chat-container').css("right", '-46%')
            } else {
                $('.chat-container').css("right", '380px')
            }
            var container = $('.chat-messages');
            container.scrollTop(container.prop('scrollHeight'));
        })

        // 打开更多
        $("#morebtn").click(function () {
            $('.modal').show()
            $("#moreOptionsPanel").css("bottom", "0px")
        })

        // 关闭更多
        $(".modal").click(function () {
            $(this).hide()
            $("#moreOptionsPanel").css("bottom", "-100%")
        })

        getChatList();
        function getChatList() {
            $.ajax({
                url: `//${apiUrl}/pixel/chat/list`,
                type: 'POST',
                // 用于设置响应体的类型 注意 跟 data 参数没关系！！！
                dataType: 'json',
                async: true,
                beforeSend: function (xhr) {
                    // 在所有发送请求的操作（open, send）之前执行
                    console.log('beforeSend', xhr)
                },
                success: function (res) {
                    // 隐藏 loading
                    // 只有请求成功（状态码为200）才会执行这个函数
                    if (res.code != 0) {
                        alert(res.msg)
                        return;
                    }

                    var list = res.data.list
                    for (const key in list) {
                        appendChatMsg(list[key].username, list[key].msg)
                    }
                },
                error: function (xhr) {
                    // 隐藏 loading
                    // 只有请求不正常（状态码不为200）才会执行
                    console.log('error', xhr)
                },
                complete: function (xhr) {
                    // 不管是成功还是失败都是完成，都会执行这个 complete 函数
                    console.log('complete', xhr)
                }
            })
        }

        // 发送聊天消息
        $('.send-button').click(function() {
            var message = $('.chat-input').val().trim();
            if (message) {
                // 生成msg_id
                let msg_id = Date.now().toString(36) + Math.random().toString(36).substring(2);
                wsObj.sendMSG("pixel_chat", {
                    msg: message,
                    msg_id: msg_id,
                });
                $('.chat-input').val('');
            }
        });
        $('.chat-input').on("keydown", function(even) {

            if (even.which != 13) {
                return;
            }

            var message = $('.chat-input').val().trim();
            if (message) {
                // 生成msg_id
                let msg_id = Date.now().toString(36) + Math.random().toString(36).substring(2);
                wsObj.sendMSG("pixel_chat", {
                    msg: message,
                    msg_id: msg_id,
                });
                $('.chat-input').val('');
            }
        });

        // 追加聊天记录
        function appendChatMsg(title, message) {
            message = document.createTextNode(message);
            var p = document.createElement('p');
            p.appendChild(message);
            message = p.innerHTML;

            var messagesContainer = $('.chat-messages');
            var newMessage = $('<div>', { 'class': 'message' });
            var formattedMessage = `<span class="greenText">[${title}] :</span><p>${message}</p>`;
            newMessage.html(formattedMessage);
            messagesContainer.append(newMessage);
            messagesContainer.scrollTop(messagesContainer.prop('scrollHeight'));
        }

        // 添加弹幕
        function addDanmu(text) {
            var container = $('#danmu-container');
            var danmu = $('<div class="danmu-message"></div>');
            danmu.text(text);
            container.append(danmu);

            var topPos = Math.random() * (container.height() - danmu.height()) - 30;
            topPos = topPos < 50 ? 50 : topPos;
            var animationDuration = 5 + Math.random() * 5; // 随机持续时间，例如5到10秒
            var danmuColors = [
                "rgba(106, 27, 154, 0.9)", // 深紫色渐变
                "rgba(76, 175, 80, 0.9)",  // 明亮的绿色
                "rgba(255, 87, 34, 0.9)",  // 鲜艳的红色
                "rgba(3, 169, 244, 0.9)",  // 天空蓝色
                "rgba(255, 152, 0, 0.9)",  // 活力橙色
                "rgba(233, 30, 99, 0.9)",  // 柔和粉色
                "rgba(158, 158, 158, 0.9)",// 经典灰色
                "rgba(255, 235, 59, 0.9)", // 霓虹黄色
                "rgba(0, 150, 136, 0.9)",  // 宁静蓝绿色
                "rgba(121, 85, 72, 0.9)"   // 优雅米色
            ];
            // var danmuColorsIndex = Math.floor(Math.random() * 10);
            if (danmuColorsIndex > 9) {
                danmuColorsIndex = 0
            }
            var fontColor = "#FFFFFF"
            if (danmuColorsIndex === 7) {
                fontColor = "#DC143C"
            }
            danmu.css({
                top: topPos,
                animationDuration: animationDuration + 's',
                "background-color": danmuColors[danmuColorsIndex],
                color: fontColor,
            });

            danmu.on('animationend', function() {
                $(this).remove(); // 动画完成后移除元素
            });

            danmuColorsIndex++
        }

        // 发送弹幕
        $('.danmu-button').click(function() {
            var text = $('.chat-input').val();
            addDanmu(text)
        });

        addDanmu("请不要创作政治敏感内容！！！")

        // 加载画布
        function loadCanvas() {
            $(".bigContentBody").html(listLoadingContent)
            $(".bigContent").show();

            let progressPercentage = 0;
            const progressUpdateTimer = setInterval(() => {
                if (progressPercentage >= 99) {
                    clearInterval(progressUpdateTimer);
                } else {
                    const progressStep = (Math.random() + 1) * 20;
                    progressPercentage += progressStep;
                    progressPercentage = parseFloat(progressPercentage.toFixed(2)); // 格式化为两位小数并转换为数字
                    progressPercentage = Math.min(99.99, progressPercentage); // 确保不超过 99.99%
                    // 更近进度条
                    $('.bigContentBody').find('#myBar').text(progressPercentage+"%").css({
                        width: progressPercentage+"%"
                    });
                }
            }, 1000);
            let nowTime = (new Date).getTime();
            let xhr = new XMLHttpRequest();
            xhr.open('GET', '/static/pixel/img/canvas.png?t=' + nowTime, true);
            xhr.responseType = 'blob';

            xhr.onloadstart = function() {
                // 初始化进度条或加载提示
                console.log('开始加载图片');
            };

            xhr.onload = function() {
                if (this.status === 200) {
                    let blob = this.response;
                    let img = new Image();
                    img.onload = function() {
                        // 使用图片
                        setTimeout(function (){
                            context.fillStyle = context.createPattern(img, 'repeat');
                            context.fillRect(0, 0, 1000, 1000);
                            window.URL.revokeObjectURL(img.src); // 释放内存
                        }, 130)

                        clearInterval(progressUpdateTimer);
                        // 更近进度条
                        $('.bigContentBody').find('#myBar').text("100%").css({
                            width: "100%"
                        });

                        // 防止闪屏
                        setTimeout(function (){
                            $(".bigContent").hide();
                        }, 500)
                    };
                    img.src = window.URL.createObjectURL(blob);
                }
            };

            xhr.onerror = function() {
                console.error('图片加载失败');
                // 处理图片加载错误
            };

            xhr.send();
        }
    });
</script>
</html>
